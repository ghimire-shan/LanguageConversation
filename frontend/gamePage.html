<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Language Converter AI - Final with 15s Transcript</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
      /* ================= CSS STYLES ================= */
      /* --- CSS VARIABLES --- */
      :root {
        --bg-color: #f8fafc;
        --card-bg: #ffffff;
        --card-hover-bg: #f8fafc;
        --text-primary: #1a1a1a;
        --text-secondary: #6b7280;
        --accent-blue: #3b82f6;
        --accent-teal: #14b8a6;
        --accent-indigo: #6366f1;
        --accent-rose: #e11d48;
        --button-dark: #1f2937;
        --border-light: #e2e8f0;
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08),
          0 2px 4px -1px rgba(0, 0, 0, 0.04);
        --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.08),
          0 8px 10px -6px rgba(0, 0, 0, 0.02);
        --radius-lg: 24px;
      }

      /* --- BASE STYLES --- */
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background-color: var(--bg-color);
        margin: 0;
        min-height: 100vh;
        position: relative;
      }

      /* --- ENTRANCE ANIMATIONS --- */
      @keyframes slideDownFade {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes slideUpFade {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .stagger-1 {
        animation: slideDownFade 0.6s ease-out backwards;
      }
      .stagger-2 {
        animation: slideUpFade 0.6s ease-out backwards 0.2s;
      }
      .stagger-3 {
        animation: slideUpFade 0.6s ease-out backwards 0.3s;
      }
      .stagger-4 {
        animation: slideUpFade 0.6s ease-out backwards 0.5s;
      }

      /* --- CONFETTI STYLES --- */
      #confetti-container {
        position: absolute;
        inset: 0;
        z-index: 0;
        pointer-events: none;
        overflow: hidden;
      }
      .confetti-piece {
        position: absolute;
        border-radius: 2px;
      }

      /* --- VIEW SWITCHING UTILITIES --- */
      .view-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        padding: 1rem;
        z-index: 10;
        pointer-events: none;
      }
      @media (min-width: 768px) {
        .view-container {
          padding: 2rem;
        }
      }
      .active-view {
        opacity: 1;
        transform: translateY(0) scale(1);
        pointer-events: auto;
        filter: blur(0px);
      }
      .hidden-view {
        opacity: 0;
        transform: translateY(20px) scale(0.98);
        filter: blur(4px);
      }

      .hidden {
        display: none;
      }

      /* --- MAIN LAYOUT CONTAINER --- */
      .main-layout-grid {
        display: flex;
        justify-content: center;
        gap: 2rem;
        max-width: 1000px;
        width: 100%;
        margin: 0 auto;
        height: 100%;
        align-items: stretch;
      }
      @media (max-width: 768px) {
        .main-layout-grid {
          flex-direction: column;
          height: auto;
        }
      }

      /* --- THE CARD STYLES --- */
      .app-card {
        background-color: var(--card-bg);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        padding: 2.5rem;
        flex: 1;
        display: flex;
        flex-direction: column;
        border: 1px solid var(--border-light);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
        position: relative;
      }
      @media (hover: hover) {
        .app-card:hover {
          background-color: var(--card-hover-bg);
          transform: translateY(-8px);
          box-shadow: var(--shadow-lg);
          border-color: #cbd5e1;
        }
      }
      .card-centered {
        align-items: center;
        text-align: center;
        justify-content: center;
      }

      /* --- AVATAR DYNAMIC COLORS --- */
      .avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        box-shadow: var(--shadow-sm);
        transition: background 0.5s ease;
      }
      body.mode-conversation .avatar {
        background: linear-gradient(135deg, #60a5fa, var(--accent-blue));
      }
      body.mode-practice .avatar {
        background: linear-gradient(135deg, #a5b4fc, var(--accent-indigo));
      }
      body.mode-clone .avatar {
        background: linear-gradient(135deg, #fda4af, var(--accent-rose));
      }

      /* --- COMPONENT STYLES --- */
      .mic-button {
        background-color: var(--button-dark);
        color: white;
        width: 100%;
        padding: 1rem;
        border-radius: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: var(--shadow-md);
        position: relative;
        overflow: hidden;
        z-index: 1;
      }
      .mic-button:hover {
        transform: scale(1.02);
        box-shadow: var(--shadow-lg);
      }
      .mic-button:active {
        transform: scale(0.98);
      }
      .mic-button.active-state {
        background: linear-gradient(
          to right,
          var(--accent-blue),
          var(--accent-teal)
        );
      }

      /* Voice Bar Animations */
      .voice-bar {
        width: 4px;
        height: 4px;
        background-color: var(--text-secondary);
        border-radius: 2px;
        opacity: 0.3;
        transition: all 0.2s ease;
      }
      .animate-voice .voice-bar {
        opacity: 1 !important;
        background-color: var(--accent-blue) !important;
      }
      .animate-voice .voice-bar:nth-child(1) {
        animation: bounceBar 0.8s infinite 0.1s;
      }
      .animate-voice .voice-bar:nth-child(2) {
        animation: bounceBar 0.6s infinite 0.3s;
      }
      .animate-voice .voice-bar:nth-child(3) {
        animation: bounceBar 0.7s infinite 0s;
      }
      .animate-voice .voice-bar:nth-child(4) {
        animation: bounceBar 0.5s infinite 0.4s;
      }
      .animate-voice .voice-bar:nth-child(5) {
        animation: bounceBar 0.6s infinite 0.2s;
      }
      @keyframes bounceBar {
        0%,
        100% {
          height: 24px;
        }
        50% {
          height: 40px;
        }
      }

      .transcript-box {
        flex: 1;
        background-color: var(--bg-color);
        border-radius: 18px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        display: flex;
        flex-direction: column;
        border: 1px solid var(--border-light);
        transition: border-color 0.3s ease;
      }
      .app-card:hover .transcript-box {
        border-color: #cbd5e1;
      }

      /* --- CHAT BUBBLES (shared) --- */
      .chat-bubble {
        max-width: 80%;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        font-size: 0.95rem;
        line-height: 1.4;
        box-shadow: var(--shadow-md);
      }
      .chat-bubble.user-bubble {
        margin-left: auto;
        background-color: #ffffff;
        color: var(--text-primary);
        border: 1px solid var(--border-light);
      }
      .chat-bubble.ai-bubble {
        margin-right: auto;
        background-color: var(--accent-teal);
        color: #ffffff;
        font-weight: 600;
      }

      /* Bottom Nav Specifics */
      .bottom-nav-container {
        position: fixed;
        bottom: 1.5rem;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 450px;
        z-index: 50;
      }
      .bottom-nav {
        background-color: var(--card-bg);
        padding: 0.5rem;
        border-radius: 100px;
        box-shadow: var(--shadow-lg);
        display: flex;
        gap: 0.5rem;
        border: 1px solid var(--border-light);
      }
      .nav-button {
        padding: 0.75rem 1rem;
        border-radius: 100px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        flex: 1;
        text-align: center;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
        font-size: 0.9rem;
      }
      .nav-button.active {
        background-color: var(--bg-color);
        color: var(--text-primary);
        box-shadow: var(--shadow-sm);
      }
      .nav-button.inactive {
        color: var(--text-secondary);
        background-color: transparent;
      }
      .nav-button.inactive:hover {
        background-color: rgba(0, 0, 0, 0.03);
      }

      /* Utilities */
      .tactile-touch {
        transition: transform 0.1s;
        cursor: pointer;
      }
      .tactile-touch:active {
        transform: scale(0.95);
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    </style>
  </head>
  <body class="h-full overflow-hidden bg-[#F8FAFC] mode-practice">
    <div id="confetti-container"></div>

    <div
      class="fixed bottom-4 right-4 z-50 flex items-center gap-2 bg-white/80 backdrop-blur-md p-2 pr-4 rounded-full shadow-sm border border-slate-100 transition-all hover:shadow-md cursor-default animate-in fade-in slide-in-from-bottom-4 duration-700"
    >
      <img
        src="https://placehold.co/40x40/3B82F6/ffffff?text=MH"
        alt="Mad Hacks Logo"
        class="w-8 h-8 rounded-full"
      />
      <span class="font-bold text-slate-700 text-sm"
        >Language Converter AI</span
      >
    </div>

    <main class="relative h-full w-full overflow-hidden pb-28">
      <!-- PRACTICE VIEW (language conversion) -->
      <div id="practice-view" class="view-container active-view">
        <header
          class="flex items-center justify-between mb-6 max-w 1000px mx-auto stagger-1 relative z-20"
        >
          <div class="avatar-container relative">
            <div class="avatar"><i class="ph-bold ph-user-circle"></i></div>
            <div
              class="absolute bottom-0 right-0 w-3 h-3 bg-green-400 rounded-full border-[2px] border-white animate-pulse"
            ></div>
          </div>
          <div
            class="flex items-center gap-3 bg-white/80 backdrop-blur-sm p-2 rounded-2xl shadow-sm border border-blue-100/50"
          >
            <div
              class="flex items-center gap-1 text-orange-500 font-bold text-sm px-2"
            >
              <i class="ph-fill ph-fire text-lg"></i> 3 Day Streak
            </div>
            <div class="w-8 h-8 relative flex items-center justify-center">
              <svg class="w-full h-full rotate-[-90deg]" viewBox="0 0 36 36">
                <path
                  class="text-slate-200"
                  d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="3"
                />
                <path
                  class="text-blue-500"
                  stroke-dasharray="75, 100"
                  d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="3"
                  stroke-linecap="round"
                />
              </svg>
              <span class="absolute text-[10px] font-bold text-blue-600"
                >75%</span
              >
            </div>
          </div>
        </header>

        <div class="main-layout-grid">
          <!-- LEFT CARD: Practice Mode Controls -->
          <section class="app-card card-centered md:max-h-[80vh] stagger-2">
            <h1
              class="text-2xl md:text-3xl font-bold text-slate-800 mb-2 tracking-tight"
            >
              Practice Mode
            </h1>
            <p class="text-base text-slate-500 font-medium mb-8">
              Tap the mic to start speaking.
            </p>

            <div
              class="w-full max-w-xs flex flex-col gap-4 items-center relative z-10 mb-2"
            >
              <!-- DROPDOWN 1: LANGUAGE (KEEPING YOUR FLAG + NAME SETUP) -->
              <div
                class="w-full flex items-center justify-center bg-slate-50 p-3 rounded-2xl border border-slate-200 shadow-sm transition-colors hover:border-blue-200 relative"
              >
                <select
                  id="practice-lang-select"
                  class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20"
                >
                  <option value="es">Spanish</option>
                  <option value="fr">French</option>
                </select>
                <div
                  class="flex items-center gap-2 text-blue-600 pointer-events-none z-10"
                >
                  <span class="text-slate-500 font-medium text-sm mr-1"
                    >Language:</span
                  >
                  <img
                    id="practice-lang-flag"
                    src="https://flagicons.lipis.dev/flags/4x3/es.svg"
                    alt="Target Flag"
                    class="w-5 h-4 object-cover rounded-sm shadow-sm"
                  />
                  <span id="practice-lang-name" class="font-bold text-sm"
                    >Spanish</span
                  >
                  <i class="ph-bold ph-caret-down"></i>
                </div>
              </div>

              <!-- DROPDOWN 2: MODEL (VARIABLE 1 / VARIABLE 2) -->
              <div
                class="w-full bg-slate-50 p-3 rounded-2xl border border-slate-200 shadow-sm transition-colors hover:border-blue-200"
              >
                <label
                  for="practice-model-select"
                  class="block text-slate-500 font-medium text-xs mb-1"
                >
                  Model
                </label>
                <div class="flex items-center justify-between">
                  <select
                    id="practice-model-select"
                    class="bg-transparent text-sm font-bold text-slate-700 outline-none flex-1 cursor-pointer"
                  >
                    <option value="03397b4c4be74759b72533b663fbd001">
                      Energetic Male
                    </option>
                    <option value="728f6ff2240d49308e8137ffe66008e2">
                      Adam
                    </option>
                    <option value="e0e2468ce2d746c1b20a4414435f6f48">
                      Bro
                    </option>
                  </select>
                  <i class="ph-bold ph-caret-down text-slate-400 ml-2"></i>
                </div>
              </div>

              <!-- MIC BUTTON -->
              <button id="practice-mic-btn" class="mic-button group">
                <i
                  id="practice-mic-icon"
                  class="ph-fill ph-microphone text-2xl transition-all"
                ></i>
                <div class="text-left">
                  <span id="practice-mic-text" class="block font-bold text-lg"
                    >Tap to speak</span
                  >
                  <span
                    id="practice-mic-subtext"
                    class="block text-xs opacity-70"
                    >Ready</span
                  >
                </div>
              </button>

              <!-- VOICE BARS -->
              <div
                id="practice-voice-bars"
                class="mt-2 h-10 flex items-center justify-center gap-1.5"
              >
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
              </div>
            </div>
          </section>
          <!-- RIGHT CARD: Conversation Transcript -->
          <section class="app-card md:max-h-[80vh]">
            <div class="mb-4 flex items-center justify-between">
              <div>
                <h2 class="text-xl font-bold text-slate-800 tracking-tight">
                  Conversation Transcript
                </h2>
                <p class="text-xs text-slate-400 font-medium">
                  You (white) · AI (green)
                </p>
              </div>
              <i
                class="ph-bold ph-trash text-slate-400 text-xl cursor-pointer hover:text-red-500 transition-colors p-2 tactile-touch"
                id="practice-clear-btn"
              ></i>
            </div>

            <div class="flex-1 flex flex-col overflow-hidden">
              <div class="transcript-box mb-0">
                <span
                  class="text-xs font-bold text-slate-500 tracking-wider mb-4 block"
                  >SESSION</span
                >
                <div
                  id="practice-chat-history"
                  class="flex-1 overflow-y-auto flex flex-col gap-3"
                  style="max-height: 100%"
                >
                  <p class="text-slate-400 italic text-center px-8">
                    Messages here...
                  </p>
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>

      <!-- CONVERSATION VIEW (back and forth conversation) -->
      <div id="conversation-view" class="view-container hidden-view">
        <header
          class="flex items-center justify-between mb-6 max-w 1000px mx-auto stagger-1 relative z-20"
        >
          <div class="avatar-container relative">
            <div class="avatar"><i class="ph-bold ph-user-circle"></i></div>
            <div
              class="absolute bottom-0 right-0 w-3 h-3 bg-green-400 rounded-full border-[2px] border-white animate-pulse"
            ></div>
          </div>
          <div
            class="flex items-center gap-3 bg-white/80 backdrop-blur-sm p-2 rounded-2xl shadow-sm border border-blue-100/50"
          >
            <div
              class="flex items-center gap-1 text-orange-500 font-bold text-sm px-2"
            >
              <i class="ph-fill ph-fire text-lg"></i> 3 Day Streak
            </div>
            <div class="w-8 h-8 relative flex items-center justify-center">
              <svg class="w-full h-full rotate-[-90deg]" viewBox="0 0 36 36">
                <path
                  class="text-slate-200"
                  d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="3"
                />
                <path
                  class="text-blue-500"
                  stroke-dasharray="75, 100"
                  d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="3"
                  stroke-linecap="round"
                />
              </svg>
              <span class="absolute text-[10px] font-bold text-blue-600"
                >75%</span
              >
            </div>
          </div>
        </header>

        <div class="main-layout-grid">
          <!-- LEFT CARD: Conversation Mode Controls -->
          <section class="app-card card-centered md:max-h-[80vh] stagger-2">
            <h1
              class="text-2xl md:text-3xl font-bold text-slate-800 mb-2 tracking-tight"
            >
              Conversation Mode
            </h1>
            <p class="text-base text-slate-500 font-medium mb-8">
              Have a conversation with AI in your target language.
            </p>

            <div
              class="w-full max-w-xs flex flex-col gap-4 items-center relative z-10 mb-2"
            >
              <!-- LANGUAGE SELECTOR -->
              <div
                class="w-full flex items-center justify-center bg-slate-50 p-3 rounded-2xl border border-slate-200 shadow-sm transition-colors hover:border-blue-200 relative"
              >
                <select
                  id="conversation-lang-select"
                  class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20"
                >
                  <option value="es">Spanish</option>
                  <option value="fr">French</option>
                </select>
                <div
                  class="flex items-center gap-2 text-blue-600 pointer-events-none z-10"
                >
                  <span class="text-slate-500 font-medium text-sm mr-1"
                    >Talk in:</span
                  >
                  <img
                    id="conversation-lang-flag"
                    src="https://flagicons.lipis.dev/flags/4x3/es.svg"
                    alt="Target Flag"
                    class="w-5 h-4 object-cover rounded-sm shadow-sm"
                  />
                  <span id="conversation-lang-name" class="font-bold text-sm"
                    >Spanish</span
                  >
                  <i class="ph-bold ph-caret-down"></i>
                </div>
              </div>

              <!-- MIC BUTTON -->
              <button id="conversation-mic-btn" class="mic-button group">
                <i
                  id="conversation-mic-icon"
                  class="ph-fill ph-microphone text-2xl transition-all"
                ></i>
                <div class="text-left">
                  <span
                    id="conversation-mic-text"
                    class="block font-bold text-lg"
                    >Tap to speak</span
                  >
                  <span
                    id="conversation-mic-subtext"
                    class="block text-xs opacity-70"
                    >Ready</span
                  >
                </div>
              </button>

              <!-- VOICE BARS -->
              <div
                id="conversation-voice-bars"
                class="mt-2 h-10 flex items-center justify-center gap-1.5"
              >
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
              </div>
            </div>
          </section>

          <!-- RIGHT CARD: Conversation Chat -->
          <section class="app-card md:max-h-[80vh]">
            <div class="mb-4 flex items-center justify-between">
              <div>
                <h2 class="text-xl font-bold text-slate-800 tracking-tight">
                  Conversation
                </h2>
                <p class="text-xs text-slate-400 font-medium">
                  You (white) · AI (green)
                </p>
              </div>
              <i
                class="ph-bold ph-trash text-slate-400 text-xl cursor-pointer hover:text-red-500 transition-colors p-2 tactile-touch"
                id="conversation-chat-clear-btn"
              ></i>
            </div>

            <div class="flex-1 flex flex-col overflow-hidden min-h-0">
              <div class="transcript-box mb-0 min-h-0">
                <span
                  class="text-xs font-bold text-slate-500 tracking-wider mb-4 block"
                >
                  CHAT
                </span>
                <div
                  id="conversation-chat-container"
                  class="flex-1 overflow-y-auto flex flex-col gap-3 h-full"
                >
                  <p class="text-slate-400 italic text-center px-8">
                    Your conversation will appear here...
                  </p>
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>

      <!-- CLONE VIEW -->
      <div id="clone-view" class="view-container hidden-view">
        <header
          class="flex items-center justify-between mb-6 max-w 1000px mx-auto relative z-20"
        >
          <div class="avatar-container relative">
            <div class="avatar"><i class="ph-bold ph-user-circle"></i></div>
          </div>
          <h2 class="text-xl font-bold text-slate-800 tracking-tight">
            Voice Cloning
          </h2>
        </header>

        <div class="main-layout-grid items-center">
          <section
            class="app-card card-centered max-w-3xl mx-auto md:max-h-[80vh]"
          >
            <div class="mb-8">
              <div
                class="w-16 h-16 bg-rose-100 rounded-2xl flex items-center justify-center text-rose-600 mx-auto mb-4 shadow-sm border border-rose-50"
              >
                <i class="ph-fill ph-wave-sawtooth text-3xl"></i>
              </div>
              <h2 class="text-3xl font-bold text-slate-800 mb-2 tracking-tight">
                Clone Your Voice
              </h2>
              <p class="text-base text-slate-500 font-medium">
                Record samples to create your AI voice model.
              </p>
            </div>

            <div class="w-full max-w-lg flex flex-col gap-8 items-center">
              <div
                class="bg-slate-50 p-6 rounded-2xl border border-slate-200 w-full shadow-sm text-center"
              >
                <p
                  class="text-sm font-bold text-slate-500 mb-3 uppercase tracking-wider"
                >
                  Instructions:
                </p>
                <p
                  class="text-base font-bold text-rose-900 leading-relaxed italic px-4"
                >
                  "Hello, my name is Alex, and I enjoy reading books about
                  technology and science. Yesterday, I walked through the park,
                  observing the beautiful autumn leaves. The weather was quite
                  pleasant, with a gentle breeze and warm sunshine. I often
                  think about how amazing our world is, full of interesting
                  discoveries waiting to be made."
                </p>
                <p class="text-sm text-slate-500 mt-4 font-medium">
                  (Please talk for about 15 seconds)
                </p>
              </div>

              <button
                id="clone-record-btn"
                class="mic-button bg-rose-600 hover:bg-rose-700 text-white tactile-touch"
              >
                <i class="ph-fill ph-microphone text-3xl"></i>
                <div class="text-left">
                  <span class="block font-bold text-2xl">Record Sample</span>
                  <span class="block text-sm opacity-80 tracking-wider"
                    >Tap and hold</span
                  >
                </div>
              </button>

              <button
                id="clone-delete-btn"
                class="flex items-center gap-2 text-red-500 font-bold hover:bg-red-50 px-6 py-3 rounded-full transition-colors tactile-touch"
              >
                <i class="ph-bold ph-trash text-xl"></i>
                Delete Voice Model
              </button>
            </div>
          </section>
        </div>
      </div>
    </main>

    <div class="bottom-nav-container stagger-4">
      <div class="bottom-nav">
        <div id="nav-conv-btn" class="nav-button active">Practice</div>
        <div id="nav-prac-btn" class="nav-button inactive">Conversation</div>
        <div id="nav-clone-btn" class="nav-button inactive">Clone Voice</div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // ================= CONFETTI LOGIC =================
        const confettiContainer = document.getElementById("confetti-container");
        const colors = ["#3B82F6", "#14B8A6", "#10B981", "#60A5FA", "#CBD5E1"];
        const numConfetti = 60;

        for (let i = 0; i < numConfetti; i++) {
          const confetti = document.createElement("div");
          confetti.classList.add("confetti-piece");
          confetti.style.left = Math.random() * 100 + "vw";
          confetti.style.top = Math.random() * 100 + "vh";
          confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
          confetti.style.backgroundColor =
            colors[Math.floor(Math.random() * colors.length)];
          const size = Math.random() * 6 + 4;
          confetti.style.width = size + "px";
          confetti.style.height =
            (Math.random() > 0.5 ? size : size * 1.5) + "px";
          confetti.style.opacity = Math.random() * 0.3 + 0.1;
          confettiContainer.appendChild(confetti);
        }

        // ================= NAVIGATION LOGIC =================
        const navConvBtn = document.getElementById("nav-conv-btn");
        const navPracBtn = document.getElementById("nav-prac-btn");
        const navCloneBtn = document.getElementById("nav-clone-btn");

        const practiceView = document.getElementById("practice-view");
        const conversationView = document.getElementById("conversation-view");
        const cloneView = document.getElementById("clone-view");

        function resetViews() {
          [navConvBtn, navPracBtn, navCloneBtn].forEach((btn) => {
            btn.classList.remove("active");
            btn.classList.add("inactive");
          });
          [practiceView, conversationView, cloneView].forEach((view) => {
            view.classList.remove("active-view");
            view.classList.add("hidden-view");
          });
          document.body.classList.remove(
            "mode-conversation",
            "mode-practice",
            "mode-clone"
          );
        }

        navConvBtn.addEventListener("click", () => {
          resetViews();
          document.body.classList.add("mode-practice");
          navConvBtn.classList.add("active");
          navConvBtn.classList.remove("inactive");
          practiceView.classList.add("active-view");
          practiceView.classList.remove("hidden-view");
        });

        navPracBtn.addEventListener("click", () => {
          resetViews();
          document.body.classList.add("mode-conversation");
          navPracBtn.classList.add("active");
          navPracBtn.classList.remove("inactive");
          conversationView.classList.add("active-view");
          conversationView.classList.remove("hidden-view");
        });

        navCloneBtn.addEventListener("click", () => {
          resetViews();
          document.body.classList.add("mode-clone");
          navCloneBtn.classList.add("active");
          navCloneBtn.classList.remove("inactive");
          cloneView.classList.add("active-view");
          cloneView.classList.remove("hidden-view");
        });

        // ========== SHARED HELPERS FOR CHAT BUBBLES ==========
        function createUserBubble(text) {
          const bubble = document.createElement("div");
          bubble.className =
            "chat-bubble bg-white text-slate-800 self-start rounded-2xl";
          bubble.textContent = text;
          return bubble;
        }

        function createAiBubble(text, audioBase64 = null) {
          const bubble = document.createElement("div");
          bubble.className =
            "chat-bubble bg-gradient-to-br from-blue-500 to-teal-500 text-white self-end rounded-2xl";

          const textDiv = document.createElement("div");
          textDiv.textContent = text;
          bubble.appendChild(textDiv);

          // Add play button if audio is provided
          if (audioBase64) {
            const playButton = createAudioPlayButton(audioBase64);
            bubble.appendChild(playButton);
          }

          return bubble;
        }

        function createAudioPlayButton(audioBase64) {
          const button = document.createElement("button");
          button.className =
            "mt-2 flex items-center gap-2 px-3 py-1.5 bg-white/20 hover:bg-white/30 rounded-full text-xs font-bold transition-colors";
          button.innerHTML = '<i class="ph-bold ph-play"></i> Play Audio';

          let audioUrl = null;
          let audio = null;

          button.addEventListener("click", () => {
            if (!audioUrl) {
              // Convert base64 to audio URL
              const audioData = atob(audioBase64);
              const audioArray = new Uint8Array(audioData.length);
              for (let i = 0; i < audioData.length; i++) {
                audioArray[i] = audioData.charCodeAt(i);
              }
              const audioBlob = new Blob([audioArray], { type: "audio/wav" });
              audioUrl = URL.createObjectURL(audioBlob);
            }

            // Stop any currently playing audio
            if (audio) {
              audio.pause();
              audio.currentTime = 0;
            }

            // Play audio
            audio = new Audio(audioUrl);
            audio.play();

            // Update button while playing
            button.innerHTML = '<i class="ph-bold ph-pause"></i> Playing...';
            button.disabled = true;

            audio.onended = () => {
              button.innerHTML = '<i class="ph-bold ph-play"></i> Play Audio';
              button.disabled = false;
            };

            audio.onerror = () => {
              button.innerHTML = '<i class="ph-bold ph-play"></i> Play Audio';
              button.disabled = false;
            };
          });

          return button;
        }

        // ================= PRACTICE MODE (language conversion) =================
        const practiceMicBtn = document.getElementById("practice-mic-btn");
        const practiceMicIcon = document.getElementById("practice-mic-icon");
        const practiceMicText = document.getElementById("practice-mic-text");
        const practiceMicSubtext = document.getElementById(
          "practice-mic-subtext"
        );
        const practiceVoiceBars = document.getElementById(
          "practice-voice-bars"
        );
        const practiceClearBtn = document.getElementById("practice-clear-btn");
        const practiceLangSelect = document.getElementById(
          "practice-lang-select"
        );
        const practiceLangFlag = document.getElementById("practice-lang-flag");
        const practiceLangNameSpan =
          document.getElementById("practice-lang-name");
        const practiceChatHistory = document.getElementById(
          "practice-chat-history"
        );

        function updatePracticeLanguageUI() {
          const selectedLangCode = practiceLangSelect.value;
          let flagUrl = "";
          let langName = "";

          if (selectedLangCode === "es") {
            flagUrl = "https://flagicons.lipis.dev/flags/4x3/es.svg";
            langName = "Spanish";
          } else if (selectedLangCode === "fr") {
            flagUrl = "https://flagicons.lipis.dev/flags/4x3/fr.svg";
            langName = "French";
          }

          practiceLangFlag.src = flagUrl;
          practiceLangFlag.alt = `${langName} Flag`;
          practiceLangNameSpan.textContent = langName;
        }

        practiceLangSelect.addEventListener("change", updatePracticeLanguageUI);

        // CHAT HISTORY MANAGEMENT FOR PRACTICE MODE
        function getChatHistory() {
          const stored = sessionStorage.getItem("practice_history");
          return stored ? JSON.parse(stored) : [];
        }

        function saveChatHistory(history) {
          sessionStorage.setItem("practice_history", JSON.stringify(history));
        }

        function addMessageToHistory(role, content) {
          const history = getChatHistory();
          history.push({ role, content });
          if (history.length > 20) {
            history.shift();
          }
          saveChatHistory(history);
        }

        // PRACTICE MODE: Record and send to backend
        let isPracticeMicActive = false;
        let practiceMediaRecorder = null;
        let practiceAudioChunks = [];
        let practiceStream = null;

        async function handlePracticeMicToggle() {
          isPracticeMicActive = !isPracticeMicActive;

          if (isPracticeMicActive) {
            // Start recording
            try {
              practiceStream = await navigator.mediaDevices.getUserMedia({
                audio: true,
              });
              practiceAudioChunks = [];
              practiceMediaRecorder = new MediaRecorder(practiceStream, {
                mimeType: "audio/webm",
              });

              practiceMediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) {
                  practiceAudioChunks.push(e.data);
                }
              };

              practiceMediaRecorder.start();

              // UI updates
              practiceMicBtn.classList.add("active-state");
              practiceMicIcon.classList.remove("ph-microphone");
              practiceMicIcon.classList.add("ph-waveform", "animate-pulse");
              practiceMicText.textContent = "Listening...";
              practiceMicSubtext.textContent = "Speak clearly";
              practiceVoiceBars.classList.add("animate-voice");
            } catch (err) {
              console.error("MIC ERROR:", err);
              alert("Microphone blocked. Check browser permissions.");
              isPracticeMicActive = false;
            }
          } else {
            // Stop recording and send to backend
            if (
              practiceMediaRecorder &&
              practiceMediaRecorder.state !== "inactive"
            ) {
              practiceMediaRecorder.stop();
            }

            practiceMediaRecorder.onstop = async () => {
              const audioBlob = new Blob(practiceAudioChunks, {
                type: "audio/webm",
              });

              // Stop audio stream
              if (practiceStream) {
                practiceStream.getTracks().forEach((track) => track.stop());
              }

              // Send to backend
              await sendPracticeAudioToBackend(audioBlob);
            };

            // UI back to normal
            practiceMicBtn.classList.remove("active-state");
            practiceMicIcon.classList.remove("ph-waveform", "animate-pulse");
            practiceMicIcon.classList.add("ph-microphone");
            practiceMicText.textContent = "Tap to speak";
            practiceMicSubtext.textContent = "Processing...";
            practiceVoiceBars.classList.remove("animate-voice");
          }
        }

        async function sendPracticeAudioToBackend(audioBlob) {
          try {
            const formData = new FormData();
            formData.append("file", audioBlob, "audio.webm");

            // Get target language and model ID
            const targetLang = practiceLangSelect.value;
            const modelId =
              document.getElementById("practice-model-select").value ||
              localStorage.getItem("user_voice_model_id") ||
              "03397b4c4be74759b72533b663fbd001";

            formData.append("target_lang", targetLang);
            formData.append("model_id", modelId);

            // Clear placeholder if present
            const placeholder =
              practiceChatHistory.querySelector("p.text-slate-400");
            if (placeholder) {
              practiceChatHistory.innerHTML = "";
            }

            const response = await fetch("http://localhost:8000/api/practice", {
              method: "POST",
              body: formData,
            });

            if (!response.ok) {
              const errorData = await response
                .json()
                .catch(() => ({ detail: `Server error: ${response.status}` }));
              throw new Error(
                errorData.detail || `Server error: ${response.status}`
              );
            }

            const result = await response.json();

            // Display user message (original transcription - we'll show corrected text as user said it)
            const userBubbleFinal = createUserBubble(
              result.initial_text || "Processing..."
            );
            practiceChatHistory.appendChild(userBubbleFinal);
            practiceChatHistory.scrollTop = practiceChatHistory.scrollHeight;

            // Display AI reply (corrected text) with audio play button
            const aiBubble = createAiBubble(
              result.corrected_text || "Processing...",
              result.audio_base64 || null
            );
            practiceChatHistory.appendChild(aiBubble);
            practiceChatHistory.scrollTop = practiceChatHistory.scrollHeight;

            // Auto-play audio if available (user can replay using the button)
            if (result.audio_base64) {
              const audioData = atob(result.audio_base64);
              const audioArray = new Uint8Array(audioData.length);
              for (let i = 0; i < audioData.length; i++) {
                audioArray[i] = audioData.charCodeAt(i);
              }
              const audioBlob = new Blob([audioArray], { type: "audio/wav" });
              const audioUrl = URL.createObjectURL(audioBlob);
              const audio = new Audio(audioUrl);
              audio.play();
              audio.onended = () => URL.revokeObjectURL(audioUrl);
            }

            // Update UI
            practiceMicSubtext.textContent = "Ready to speak";
          } catch (err) {
            console.error("Upload failed:", err);
            alert(`Error: ${err.message}`);
            practiceMicSubtext.textContent = "Error - try again";
          }
        }

        practiceMicBtn.addEventListener("click", handlePracticeMicToggle);

        if (practiceClearBtn) {
          practiceClearBtn.addEventListener("click", () => {
            practiceChatHistory.innerHTML = `
              <p class="text-slate-400 italic text-center px-8">
                Messages here...
              </p>
            `;
            sessionStorage.removeItem("practice_history");
          });
        }

        // Initialize Practice Mode UI on load
        updatePracticeLanguageUI();

        // ================= CLONE MODE LOGIC =================
        const cloneRecordBtn = document.getElementById("clone-record-btn");
        const cloneDeleteBtn = document.getElementById("clone-delete-btn");

        // CLONE MODE: Record and send to backend
        let cloneMediaRecorder = null;
        let cloneAudioChunks = [];
        let cloneStream = null;
        let isCloneMicActive = false;

        async function handleCloneRecord() {
          isCloneMicActive = !isCloneMicActive;

          if (isCloneMicActive) {
            // Start recording
            try {
              cloneStream = await navigator.mediaDevices.getUserMedia({
                audio: true,
              });
              cloneAudioChunks = [];
              cloneMediaRecorder = new MediaRecorder(cloneStream, {
                mimeType: "audio/webm",
              });

              cloneMediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) {
                  cloneAudioChunks.push(e.data);
                }
              };

              cloneMediaRecorder.start();

              // UI updates
              cloneRecordBtn.classList.add("active-state");
              cloneRecordBtn.innerHTML = `
                    <i class="ph-fill ph-waveform text-3xl animate-pulse"></i>
                    <div class="text-left">
                        <span class="block font-bold text-2xl">Recording...</span>
                        <span class="block text-sm opacity-80 tracking-wider">Release to stop</span>
                    </div>
                `;
            } catch (err) {
              console.error("MIC ERROR:", err);
              alert("Microphone blocked. Check browser permissions.");
              isCloneMicActive = false;
            }
          } else {
            // Stop recording and send to backend
            if (cloneMediaRecorder && cloneMediaRecorder.state !== "inactive") {
              cloneMediaRecorder.stop();
            }

            cloneMediaRecorder.onstop = async () => {
              const audioBlob = new Blob(cloneAudioChunks, {
                type: "audio/webm",
              });

              // Stop audio stream
              if (cloneStream) {
                cloneStream.getTracks().forEach((track) => track.stop());
              }

              // Send to backend
              await sendCloneAudioToBackend(audioBlob);
            };

            // UI back to normal
            cloneRecordBtn.classList.remove("active-state");
            cloneRecordBtn.innerHTML = `
                <i class="ph-fill ph-microphone text-3xl"></i>
                <div class="text-left">
                    <span class="block font-bold text-2xl">Record Sample</span>
                    <span class="block text-sm opacity-80 tracking-wider">Tap and hold</span>
                </div>
            `;
          }
        }

        async function sendCloneAudioToBackend(audioBlob) {
          try {
            const formData = new FormData();
            formData.append("file", audioBlob, "audio.webm");

            // Get voice name (you might want to add an input field for this)
            const voiceName = prompt(
              "Enter a name for your voice clone:",
              "My Voice"
            );
            if (!voiceName) {
              return; // User cancelled
            }

            formData.append("voice_name", voiceName);

            // Note: This endpoint requires authentication
            // You'll need to include the auth token in headers
            const token = localStorage.getItem("access_token");
            const headers = {};
            if (token) {
              headers["Authorization"] = `Bearer ${token}`;
            }

            cloneRecordBtn.disabled = true;
            cloneRecordBtn.innerHTML = `
                <i class="ph-bold ph-spinner animate-spin text-3xl"></i>
                <div class="text-left">
                    <span class="block font-bold text-2xl">Creating clone...</span>
                    <span class="block text-sm opacity-80 tracking-wider">Please wait</span>
                </div>
            `;

            const response = await fetch(
              "http://localhost:8000/api/create_clone",
              {
                method: "POST",
                headers: headers,
                body: formData,
              }
            );

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(
                errorData.detail || `Server error: ${response.status}`
              );
            }

            const result = await response.json();
            console.log("Clone created:", result);

            // Store the model ID if returned
            if (result.voice_id) {
              localStorage.setItem("user_voice_model_id", result.voice_id);
            }

            alert(`Voice clone "${voiceName}" created successfully!`);

            // Reset button
            cloneRecordBtn.disabled = false;
            cloneRecordBtn.innerHTML = `
                <i class="ph-fill ph-microphone text-3xl"></i>
                <div class="text-left">
                    <span class="block font-bold text-2xl">Record Sample</span>
                    <span class="block text-sm opacity-80 tracking-wider">Tap and hold</span>
                </div>
            `;
          } catch (err) {
            console.error("Clone creation failed:", err);
            alert(`Error: ${err.message}`);

            // Reset button
            cloneRecordBtn.disabled = false;
            cloneRecordBtn.innerHTML = `
                <i class="ph-fill ph-microphone text-3xl"></i>
                <div class="text-left">
                    <span class="block font-bold text-2xl">Record Sample</span>
                    <span class="block text-sm opacity-80 tracking-wider">Tap and hold</span>
                </div>
            `;
          }
        }

        cloneRecordBtn.addEventListener("mousedown", () => handleCloneRecord());
        cloneRecordBtn.addEventListener("mouseup", () => {
          if (isCloneMicActive) {
            handleCloneRecord();
          }
        });
        cloneRecordBtn.addEventListener("mouseleave", () => {
          if (isCloneMicActive) {
            handleCloneRecord();
          }
        });

        cloneDeleteBtn.addEventListener("click", async () => {
          if (!confirm("Are you sure you want to delete your voice clone?")) {
            return;
          }

          try {
            const token = localStorage.getItem("access_token");
            const headers = {
              "Content-Type": "application/json",
            };
            if (token) {
              headers["Authorization"] = `Bearer ${token}`;
            }

            // Note: You'll need to add a DELETE endpoint in the backend
            const response = await fetch(
              "http://localhost:8000/api/delete_clone",
              {
                method: "DELETE",
                headers: headers,
              }
            );

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(
                errorData.detail || `Server error: ${response.status}`
              );
            }

            localStorage.removeItem("user_voice_model_id");
            alert("Voice clone deleted successfully!");
          } catch (err) {
            console.error("Delete failed:", err);
            alert(`Error: ${err.message}`);
          }
        });

        // ================= CONVERSATION MODE LOGIC =================
        const conversationMicBtn = document.getElementById(
          "conversation-mic-btn"
        );
        const conversationMicIcon = document.getElementById(
          "conversation-mic-icon"
        );
        const conversationMicText = document.getElementById(
          "conversation-mic-text"
        );
        const conversationMicSubtext = document.getElementById(
          "conversation-mic-subtext"
        );
        const conversationVoiceBars = document.getElementById(
          "conversation-voice-bars"
        );
        const conversationChatClearBtn = document.getElementById(
          "conversation-chat-clear-btn"
        );
        const conversationLangSelect = document.getElementById(
          "conversation-lang-select"
        );
        const conversationLangFlag = document.getElementById(
          "conversation-lang-flag"
        );
        const conversationLangNameSpan = document.getElementById(
          "conversation-lang-name"
        );
        const conversationChatContainer = document.getElementById(
          "conversation-chat-container"
        );

        // Language UI for conversation mode
        function updateConversationLanguageUI() {
          const selectedLangCode = conversationLangSelect.value;
          let flagUrl = "";
          let langName = "";

          if (selectedLangCode === "es") {
            flagUrl = "https://flagicons.lipis.dev/flags/4x3/es.svg";
            langName = "Spanish";
          } else if (selectedLangCode === "fr") {
            flagUrl = "https://flagicons.lipis.dev/flags/4x3/fr.svg";
            langName = "French";
          }

          conversationLangFlag.src = flagUrl;
          conversationLangFlag.alt = `${langName} Flag`;
          conversationLangNameSpan.textContent = langName;
        }

        conversationLangSelect.addEventListener(
          "change",
          updateConversationLanguageUI
        );

        // Helpers for base64 audio → playable URL
        function base64ToBlob(base64) {
          const cleaned = base64.trim();
          // If the backend already sends a data URL, just skip
          if (cleaned.startsWith("data:audio")) {
            // We'll use this string directly as src
            return cleaned;
          }
          const binary = atob(cleaned);
          const len = binary.length;
          const bytes = new Uint8Array(len);
          for (let i = 0; i < len; i++) {
            bytes[i] = binary.charCodeAt(i);
          }
          const blob = new Blob([bytes]); // no explicit type so browser sniffs it
          return URL.createObjectURL(blob);
        }

        let currentAudio = null;

        function createPlayButton(onClick, extraClasses = "") {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = `tactile-touch flex items-center gap-2 px-3 py-1.5 rounded-full font-bold text-xs ${extraClasses}`;
          btn.innerHTML = '<i class="ph-bold ph-play"></i> Play';
          btn.addEventListener("click", () => {
            if (currentAudio) {
              currentAudio.pause();
              currentAudio.currentTime = 0;
            }
            onClick();
          });
          return btn;
        }

        // ================= CONVERSATION MODE LOGIC =================
        // CHAT HISTORY MANAGEMENT FOR CONVERSATION MODE
        function getConversationHistory() {
          const stored = sessionStorage.getItem("conversation_history");
          return stored ? JSON.parse(stored) : [];
        }

        function saveConversationHistory(history) {
          sessionStorage.setItem(
            "conversation_history",
            JSON.stringify(history)
          );
        }

        function addConversationMessage(role, content) {
          const history = getConversationHistory();
          history.push({ role, content });
          if (history.length > 20) {
            history.shift();
          }
          saveConversationHistory(history);
        }

        // CONVERSATION MODE: Record and send to backend
        let conversationMediaRecorder = null;
        let conversationAudioChunks = [];
        let conversationStream = null;
        let isConversationMicActive = false;

        async function handleConversationMicToggle() {
          isConversationMicActive = !isConversationMicActive;

          if (isConversationMicActive) {
            // Start recording
            try {
              conversationStream = await navigator.mediaDevices.getUserMedia({
                audio: true,
              });
              conversationAudioChunks = [];
              conversationMediaRecorder = new MediaRecorder(
                conversationStream,
                {
                  mimeType: "audio/webm",
                }
              );

              conversationMediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) {
                  conversationAudioChunks.push(e.data);
                }
              };

              conversationMediaRecorder.start();

              // UI updates
              conversationMicBtn.classList.add("active-state");
              conversationMicIcon.classList.remove("ph-microphone");
              conversationMicIcon.classList.add("ph-waveform", "animate-pulse");
              conversationMicText.textContent = "Listening...";
              conversationMicSubtext.textContent = "Speak clearly";
              conversationVoiceBars.classList.add("animate-voice");
            } catch (err) {
              console.error("MIC ERROR:", err);
              alert("Microphone blocked. Check browser permissions.");
              isConversationMicActive = false;
            }
          } else {
            // Stop recording and send to backend
            if (
              conversationMediaRecorder &&
              conversationMediaRecorder.state !== "inactive"
            ) {
              conversationMediaRecorder.stop();
            }

            conversationMediaRecorder.onstop = async () => {
              const audioBlob = new Blob(conversationAudioChunks, {
                type: "audio/webm",
              });

              // Stop audio stream
              if (conversationStream) {
                conversationStream.getTracks().forEach((track) => track.stop());
              }

              // Send to backend
              await sendConversationAudioToBackend(audioBlob);
            };

            // UI back to normal
            conversationMicBtn.classList.remove("active-state");
            conversationMicIcon.classList.remove(
              "ph-waveform",
              "animate-pulse"
            );
            conversationMicIcon.classList.add("ph-microphone");
            conversationMicText.textContent = "Tap to speak";
            conversationMicSubtext.textContent = "Processing...";
            conversationVoiceBars.classList.remove("animate-voice");
          }
        }

        async function sendConversationAudioToBackend(audioBlob) {
          try {
            const formData = new FormData();
            formData.append("file", audioBlob, "audio.webm");

            // Get target language and model ID
            const targetLang = conversationLangSelect.value;
            const modelId =
              localStorage.getItem("user_voice_model_id") ||
              "03397b4c4be74759b72533b663fbd001";

            formData.append("target_lang", targetLang);
            formData.append("model_id", modelId);

            // Get and send chat history
            const chatHistory = getConversationHistory();
            formData.append("chat_history", JSON.stringify(chatHistory));

            // Clear placeholder if present
            const placeholder =
              conversationChatContainer.querySelector("p.text-slate-400");
            if (placeholder) {
              conversationChatContainer.innerHTML = "";
            }

            const response = await fetch("http://localhost:8000/api/reply", {
              method: "POST",
              body: formData,
            });

            if (!response.ok) {
              const errorData = await response
                .json()
                .catch(() => ({ detail: `Server error: ${response.status}` }));
              throw new Error(
                errorData.detail || `Server error: ${response.status}`
              );
            }

            const result = await response.json();

            // Display user message
            const userBubble = createUserBubble(result.user_message);
            conversationChatContainer.appendChild(userBubble);
            conversationChatContainer.scrollTop =
              conversationChatContainer.scrollHeight;

            // Add user message to history
            addConversationMessage("user", result.user_message);

            // Display AI reply with audio play button
            const aiBubble = createAiBubble(
              result.reply_text,
              result.reply_audio || null
            );
            conversationChatContainer.appendChild(aiBubble);
            conversationChatContainer.scrollTop =
              conversationChatContainer.scrollHeight;

            // Add AI reply to history
            addConversationMessage("assistant", result.reply_text);

            // Auto-play audio if available (user can replay using the button)
            if (result.reply_audio) {
              const audioData = atob(result.reply_audio);
              const audioArray = new Uint8Array(audioData.length);
              for (let i = 0; i < audioData.length; i++) {
                audioArray[i] = audioData.charCodeAt(i);
              }
              const audioBlob = new Blob([audioArray], { type: "audio/wav" });
              const audioUrl = URL.createObjectURL(audioBlob);
              const audio = new Audio(audioUrl);
              audio.play();
              audio.onended = () => URL.revokeObjectURL(audioUrl);
            }

            // Update UI
            conversationMicSubtext.textContent = "Ready to speak";
          } catch (err) {
            console.error("Upload failed:", err);
            alert(`Error: ${err.message}`);
            conversationMicSubtext.textContent = "Error - try again";
          }
        }

        // Connect conversation mic button
        if (conversationMicBtn) {
          conversationMicBtn.addEventListener(
            "click",
            handleConversationMicToggle
          );
        }

        // Connect conversation clear button
        if (conversationChatClearBtn) {
          conversationChatClearBtn.addEventListener("click", () => {
            conversationChatContainer.innerHTML = `
            <p class="text-slate-400 italic text-center px-8">
              Your conversation will appear here...
            </p>
          `;
            sessionStorage.removeItem("conversation_history");
          });
        }

        // Initialize Conversation Mode UI on load
        if (conversationLangSelect) {
          updateConversationLanguageUI();
        }
      });
    </script>
  </body>
</html>
